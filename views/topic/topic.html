<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<% include ../head.html %>
</head>
<body>
	<div id="head">
		<% include ../top_bar.html %>
		<script type="text/javascript">$('#index').addClass('active');</script>
	</div>
	<div id="wrap">
		<div id="main">
			<div id="content">
				<div class="panel">
				    <div id="innner">
						<div>
							<ul class="breadcrumb">
							    <li><a href="#">首页</a> <span class="divider">/</span></li>
							    <li class="active">吐槽内容</li>
						    </ul>
						</div>
						<div class="topic-main">
						<% if(topic){ %>
							<div style="padding: 10px 0;">
								<div style=""><h2><%=topic.title%></h2></div>
								<hr>
								<div><%=topic.content%></div>
								<hr>
								<div>
									<div>
										标签: <span class="label label-important"><%=topic.tag%></span>
									</div>
									<div>
										<%=topic.loginname%> 在 <%=dateformat(topic.create_time, 'mm-dd HH:MM')%> 吐槽  <%=topic.loginname%> 在 <%=dateformat(topic.update_time, 'mm-dd HH:MM')%> 编辑
									</div>
									<div>
										<button type="button" class="btn btn-success">收藏一下</button>
									</div>
								</div>
							</div>
						<% }else{ %>
							<div>当前吐槽已经不纯在了!</div>
						<% } %>
						</div>
				    </div>
				</div>
				<div class="panel">
					<div class="header"><%=topic.reply_count%> 吐槽</div>
					<% for(var r in reply){ %>
					<div class="inner" style="border-bottom: 1px solid #E5E5E5;">
						<div class="inner">
							<%-markdown.toHTML(reply[r].content)%>
						</div>
						<% if(reply[r].child.length > 0){ 
							for(var i=0; i < reply[r].child.length; i++){
						%>
						<div class="inner" style="margin-left: 50px;border-top: 1px solid #EEEEEE;">
							<%-markdown.toHTML(reply[r].child[i].content) %>
						</div>
						<% } } %>
					</div>
					<% } %>
				</div>
				<div class="panel">
					<div class="header">吐槽几句</div>
					<div class="inner">
						<form action="/topic/reply" method="post" id="form1" class="form-horizontal">
							<input type="hidden" name="topic_id" value="<%=topic.id%>"/>
							<input type="hidden" name="topic_uuid" value="<%=topic.uuid%>"/>
							<div>
								<div>
									<span class="badge badge-info" id="edit_mark" style="cursor: pointer;">Markdown</span>
									<span class="badge" id="edit_pre" style="cursor: pointer;">Preview</span>
								</div>
								<textarea rows="5" name="content" placeholder="卧槽。。。" class="content-txtarea" id="edit_box"></textarea>
								<div id="preview_box" class="preview-box" style="display:none;"></div>
							</div>
							<div>
								<button type="button" id="save_btn" class="btn btn-success">发布</button>
							</div>
						</form>
					</div>
				</div>
			</div>
			<div id="sidebar">
				<% include ../user/user_info.html %>
				<div class="panel">
					<div class="header">热门吐槽</div>
					<div class="inner">
						ddd
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="foot">
	
	</div>
	<script type="text/javascript" src="<%=site_host%>/markdown.js"></script>
	<script type="text/javascript">
		$('#edit_pre').bind('click', function(){
			var preview_content = markdown.toHTML($('#edit_box').val());
			$('#edit_pre').addClass('badge-info');
			$('#edit_mark').removeClass('badge-info');
			
			$('#preview_box').html(preview_content);
			$('#edit_box').css('display', 'none');
			$('#preview_box').css('display', 'block');
		});
		$('#edit_mark').bind('click', function(){
			$('#edit_mark').addClass('badge-info');
			$('#edit_pre').removeClass('badge-info');
			
			$('#edit_box').css('display', 'block');
			$('#preview_box').css('display', 'none');
		});
		$('#new_t_btn').bind('click', function(){
			window.location.href = '/topic/newTopic';
		});
		$('#save_btn').bind('click', function(){
			$('#form1').submit();
		});
		
		
		
		HTMLTextAreaElement.prototype.getCaretPosition = function () { //return the caret position of the textarea
		    return this.selectionStart;
		};
		HTMLTextAreaElement.prototype.setCaretPosition = function (position) { //change the caret position of the textarea
		    this.selectionStart = position;
		    this.selectionEnd = position;
		    this.focus();
		};
		HTMLTextAreaElement.prototype.hasSelection = function () { //if the textarea has selection then return true
		    if (this.selectionStart == this.selectionEnd) {
		        return false;
		    } else {
		        return true;
		    }
		};
		HTMLTextAreaElement.prototype.getSelectedText = function () { //return the selection text
		    return this.value.substring(this.selectionStart, this.selectionEnd);
		};
		HTMLTextAreaElement.prototype.setSelection = function (start, end) { //change the selection area of the textarea
		    this.selectionStart = start;
		    this.selectionEnd = end;
		    this.focus();
		};
		 
		var textarea = document.getElementsByTagName('textarea')[0];
		 
		textarea.onkeydown = function(event) {
		     
		    //support tab on textarea
		    if (event.keyCode == 9) { //tab was pressed
		        var newCaretPosition;
		        newCaretPosition = textarea.getCaretPosition() + "    ".length;
		        textarea.value = textarea.value.substring(0, textarea.getCaretPosition()) + "    " + textarea.value.substring(textarea.getCaretPosition(), textarea.value.length);
		        textarea.setCaretPosition(newCaretPosition);
		        return false;
		    }
		    if(event.keyCode == 8){ //backspace
		        if (textarea.value.substring(textarea.getCaretPosition() - 4, textarea.getCaretPosition()) == "    ") { //it's a tab space
		            var newCaretPosition;
		            newCaretPosition = textarea.getCaretPosition() - 3;
		            textarea.value = textarea.value.substring(0, textarea.getCaretPosition() - 3) + textarea.value.substring(textarea.getCaretPosition(), textarea.value.length);
		            textarea.setCaretPosition(newCaretPosition);
		        }
		    }
		    if(event.keyCode == 37){ //left arrow
		        var newCaretPosition;
		        if (textarea.value.substring(textarea.getCaretPosition() - 4, textarea.getCaretPosition()) == "    ") { //it's a tab space
		            newCaretPosition = textarea.getCaretPosition() - 3;
		            textarea.setCaretPosition(newCaretPosition);
		        }   
		    }
		    if(event.keyCode == 39){ //right arrow
		        var newCaretPosition;
		        if (textarea.value.substring(textarea.getCaretPosition() + 4, textarea.getCaretPosition()) == "    ") { //it's a tab space
		            newCaretPosition = textarea.getCaretPosition() + 3;
		            textarea.setCaretPosition(newCaretPosition);
		        }
		    }
		}
	</script>
</body>
	
</html>